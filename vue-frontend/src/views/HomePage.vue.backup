<template>
    <div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black">
        <!-- æ¨™é¡Œ -->
        <header class="bg-gray-900/50 backdrop-blur-sm border-b border-gray-700">
            <div class="container mx-auto px-4 py-4">
                <h1
                    class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                    POE æµæ´¾é…ç½®åˆ†æå·¥å…·
                </h1>
                <p class="text-gray-400 text-sm mt-1">æ‰¾å‡ºé…ç½®å·®ç•° â†’ åœ¨ PoB é©—è­‰ â†’ éŠæˆ²ä¸­å¯¦è¸</p>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <!-- æ¸¬è©¦é€£ç·šæŒ‰éˆ• -->
            <section class="mb-4">
                <button @click="testApi" :disabled="loading"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition disabled:opacity-50">
                    ğŸ”§ æ¸¬è©¦ API é€£ç·š
                </button>
            </section>

            <!-- é›™ PoB è¼¸å…¥å€åŸŸ -->
            <section class="mb-8">
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">ğŸ¯ æµæ´¾é…ç½®æ¯”å°</h2>
                    <p class="text-gray-400 mb-6">è²¼ä¸Šå…©å€‹ PoB ä»£ç¢¼ï¼Œåˆ†æé…ç½®å·®ç•°ä¸¦ç”Ÿæˆæ”¹é€²æ¸…å–®</p>

                    <!-- éšæ®µé¸æ“‡å™¨ -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-green-400 mb-3">âš™ï¸ æ¯”å°éšæ®µè¨­å®š</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button v-for="stage in stages" :key="stage.id" @click="selectStage(stage.id)" :class="[
                                'py-4 px-3 rounded-lg border transition-all',
                                selectedStage === stage.id
                                    ? 'bg-green-600 border-green-500 text-white'
                                    : 'bg-gray-700 border-gray-600 text-gray-300 hover:bg-gray-600'
                            ]">
                                <div class="text-center">
                                    <div class="font-medium">{{ stage.name }}</div>
                                    <div class="text-sm mt-1">{{ stage.level }}</div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- ä½ çš„è§’è‰² PoB -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl">ğŸ§‘â€ğŸ’¼</span>
                                <h3 class="text-xl font-medium text-blue-400">ä½ çš„è§’è‰²</h3>
                            </div>

                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-gray-300">
                                    Path of Building ä»£ç¢¼
                                </label>
                                <textarea v-model="playerPobCode" placeholder="è«‹è²¼ä¸Šä½ çš„ PoB ä»£ç¢¼...

ğŸ”— å¦‚ä½•ç²å–ï¼Ÿ
1. é–‹å•Ÿ Path of Building
2. åŒ¯å…¥ä½ çš„è§’è‰²
3. é»æ“Šã€ŒåŒ¯å‡ºè‡³å‰ªè²¼æ¿ã€
4. è²¼ä¸Šåˆ°é€™è£¡" rows="8" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none font-mono text-sm"></textarea>

                                <button @click="loadPlayerBuild" :disabled="loading || !playerPobCode"
                                    class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition disabled:opacity-50">
                                    {{ loading && currentStep === 'player' ? 'è§£æä¸­...' : 'ğŸ”„ è¼‰å…¥æˆ‘çš„è§’è‰²' }}
                                </button>
                            </div>

                            <!-- ç©å®¶è§’è‰²é è¦½ -->
                            <div v-if="playerBuildData" class="bg-blue-900/20 border border-blue-700 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-blue-300 mb-2">âœ… è§’è‰²å·²è¼‰å…¥</h4>
                                <div class="text-sm space-y-1">
                                    <p><span class="text-gray-400">ç­‰ç´šï¼š</span>{{ playerBuildData.character_info?.level }}
                                    </p>
                                    <p>
                                        <span class="text-gray-400">è·æ¥­ï¼š</span>
                                        {{ playerBuildData.character_info?.class }}
                                        <span v-if="playerBuildData.character_info?.ascendancy" class="text-purple-300">
                                            ({{ playerBuildData.character_info.ascendancy }})
                                        </span>
                                    </p>
                                    <p v-if="playerBuildData.main_skill_info">
                                        <span class="text-gray-400">ä¸»æŠ€èƒ½ï¼š</span>
                                        <span class="text-green-300">{{ playerBuildData.main_skill_info.name }}</span>
                                        <span class="text-gray-500">Lv{{ playerBuildData.main_skill_info.level }}</span>
                                        <span class="text-blue-300">({{ playerBuildData.main_skill_info.linkCount
                                            }}L)</span>
                                    </p>
                                    <p>
                                        <span class="text-gray-400">å¤©è³¦é»æ•¸ï¼š</span>
                                        <span v-if="playerBuildData.passive_tree?.total > 0">
                                            {{ playerBuildData.passive_tree.total }}
                                        </span>
                                        <span v-else-if="playerBuildData.passive_tree?.url"
                                            class="text-yellow-400 text-xs">
                                            å¤©è³¦æ¨¹è³‡æ–™åœ¨ PoB ä¸­æŸ¥çœ‹
                                        </span>
                                        <span v-else class="text-gray-500">0</span>
                                    </p>
                                </div>

                                <!-- æç¤ºè¨Šæ¯ -->
                                <div
                                    class="mt-3 text-xs text-yellow-300 bg-yellow-900/20 border border-yellow-700 p-2 rounded">
                                    ğŸ’¡ DPS å’Œç”Ÿå‘½å€¼è«‹åœ¨ Path of Building ä¸­æŸ¥çœ‹
                                </div>
                            </div>
                        </div>

                        <!-- ç›®æ¨™æµæ´¾ PoB -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl">ğŸ¯</span>
                                <h3 class="text-xl font-medium text-purple-400">ç›®æ¨™æµæ´¾</h3>
                            </div>

                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-gray-300">
                                    ç›®æ¨™æµæ´¾ PoB ä»£ç¢¼
                                </label>
                                <textarea v-model="targetPobCode" placeholder="è«‹è²¼ä¸Šç›®æ¨™æµæ´¾çš„ PoB ä»£ç¢¼...

ğŸ”— å¦‚ä½•ç²å–ï¼Ÿ
1. å¾ poe.ninja æ‰¾é«˜æ‰‹æµæ´¾
2. é»æ“Šã€ŒPoBã€æŒ‰éˆ•
3. è¤‡è£½ä»£ç¢¼è²¼ä¸Šåˆ°é€™è£¡" rows="8" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none font-mono text-sm"></textarea>

                                <button @click="loadTargetBuild" :disabled="loading || !targetPobCode"
                                    class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition disabled:opacity-50">
                                    {{ loading && currentStep === 'target' ? 'è§£æä¸­...' : 'ğŸ”„ è¼‰å…¥ç›®æ¨™æµæ´¾' }}
                                </button>
                            </div>

                            <!-- ç›®æ¨™æµæ´¾é è¦½ -->
                            <div v-if="targetBuildData"
                                class="bg-purple-900/20 border border-purple-700 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-purple-300 mb-2">âœ… ç›®æ¨™æµæ´¾å·²è¼‰å…¥</h4>
                                <div class="text-sm space-y-1">
                                    <p><span class="text-gray-400">ç­‰ç´šï¼š</span>{{ targetBuildData.character_info?.level }}
                                    </p>
                                    <p>
                                        <span class="text-gray-400">è·æ¥­ï¼š</span>
                                        {{ targetBuildData.character_info?.class }}
                                        <span v-if="targetBuildData.character_info?.ascendancy" class="text-purple-300">
                                            ({{ targetBuildData.character_info.ascendancy }})
                                        </span>
                                    </p>
                                    <p v-if="targetBuildData.main_skill_info">
                                        <span class="text-gray-400">ä¸»æŠ€èƒ½ï¼š</span>
                                        <span class="text-green-300">{{ targetBuildData.main_skill_info.name }}</span>
                                        <span class="text-gray-500">Lv{{ targetBuildData.main_skill_info.level }}</span>
                                        <span class="text-blue-300">({{ targetBuildData.main_skill_info.linkCount
                                            }}L)</span>
                                    </p>
                                    <p><span class="text-gray-400">å¤©è³¦é»æ•¸ï¼š</span>{{ targetBuildData.passive_tree?.total ||
                                        0 }}</p>
                                </div>

                                <!-- æç¤ºè¨Šæ¯ -->
                                <div
                                    class="mt-3 text-xs text-yellow-300 bg-yellow-900/20 border border-yellow-700 p-2 rounded">
                                    ğŸ’¡ DPS å’Œç”Ÿå‘½å€¼è«‹åœ¨ Path of Building ä¸­æŸ¥çœ‹
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¯”å°æŒ‰éˆ• -->
                    <div class="mt-8 text-center">
                        <button @click="startComparison"
                            :disabled="loading || !playerBuildData || !targetBuildData || !selectedStage"
                            class="px-12 py-4 text-xl bg-green-600 hover:bg-green-700 text-white rounded-lg transition disabled:opacity-50">
                            {{ loading && currentStep === 'compare' ? 'åˆ†æä¸­...' : 'ğŸ”® é–‹å§‹é…ç½®æ¯”å°' }}
                        </button>

                        <p v-if="!selectedStage || !playerBuildData || !targetBuildData"
                            class="text-sm text-gray-400 mt-2">
                            è«‹å…ˆè¼‰å…¥å…©å€‹æµæ´¾ä¸¦é¸æ“‡æ¯”å°éšæ®µ
                        </p>
                    </div>
                </div>
            </section>

            <!-- æ¯”å°çµæœå€åŸŸ -->
            <section v-if="comparisonResult" class="mb-8">
                <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">ğŸ“Š é…ç½®å·®ç•°åˆ†æ</h2>

                    <!-- æ”¹é€²å»ºè­° -->
                    <div class="space-y-3">
                        <h3 class="text-xl font-bold text-white mb-4">ğŸ’¡ æ”¹é€²æ¸…å–®</h3>

                        <div v-for="(rec, index) in (comparisonResult.data?.recommendations || [])" :key="index" :class="[
                            'p-4 rounded-lg border',
                            rec.priority === 'critical' ? 'bg-red-900/20 border-red-700' :
                                rec.priority === 'high' ? 'bg-orange-900/20 border-orange-700' :
                                    rec.priority === 'medium' ? 'bg-yellow-900/20 border-yellow-700' :
                                        'bg-blue-900/20 border-blue-700'
                        ]">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">
                                    {{ rec.priority === 'critical' ? 'ğŸ”´' :
                                        rec.priority === 'high' ? 'ğŸŸ ' :
                                            rec.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸ”µ' }}
                                </span>
                                <div class="flex-1">
                                    <p class="font-medium text-white mb-1">{{ rec.message }}</p>
                                    <p class="text-sm text-gray-300 mb-2">{{ rec.action }}</p>
                                    <div class="bg-gray-900/50 p-2 rounded text-xs text-gray-400">
                                        ğŸ’¡ PoB æ“ä½œï¼š{{ rec.pob_instruction }}
                                    </div>
                                    <span class="inline-block mt-2 text-xs px-2 py-1 rounded bg-gray-700 text-gray-300">
                                        {{ rec.category }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div v-if="!comparisonResult.data?.recommendations?.length"
                            class="text-center py-8 text-gray-400">
                            <p>ğŸ‰ æ­å–œï¼æ²’æœ‰ç™¼ç¾æ˜é¡¯çš„æ”¹é€²ç©ºé–“</p>
                        </div>
                    </div>

                    <!-- é‡è¦æç¤º -->
                    <div class="mt-6 bg-blue-900/20 border border-blue-700 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-blue-300 mb-2">ğŸ“Œ ä¸‹ä¸€æ­¥è¡Œå‹•</h4>
                        <ol class="text-sm text-gray-300 space-y-2 list-decimal list-inside">
                            <li>åœ¨ Path of Building ä¸­æŒ‰ç…§ä¸Šè¿°å»ºè­°é€é …èª¿æ•´</li>
                            <li>è§€å¯Ÿå³å´çš„ DPS å’Œç”Ÿå‘½å€¼è®ŠåŒ–</li>
                            <li>ç¢ºèªæ”¹é€²æ•ˆæœå¾Œå†åœ¨éŠæˆ²ä¸­åŸ·è¡Œ</li>
                        </ol>
                    </div>
                </div>
            </section>
        </main>
    </div>
</template>

<script setup>
import { ref } from 'vue'

// API åŸºç¤ URL - æŒ‡å‘ Laravel å¾Œç«¯
const API_BASE_URL = 'http://127.0.0.1:8000/api'

// API ç›¸é—œ
const loading = ref(false)
const currentStep = ref('')

// è¡¨å–®è³‡æ–™
const playerPobCode = ref('')
const targetPobCode = ref('')

// éšæ®µé¸æ“‡
const selectedStage = ref('mapping')
const stages = [
    { id: 'leveling', name: 'éç«ç¯€', level: 'Lv 28-68', targetLevel: 68 },
    { id: 'mapping', name: 'è¼¿åœ–æ‹“è’', level: 'Lv 75-90', targetLevel: 80 },
    { id: 'endgame', name: 'çµ‚å±€åˆ·å¯¶', level: 'Lv 95+', targetLevel: 95 },
    { id: 'custom', name: 'è‡ªè¨‚ç­‰ç´š', level: 'Custom', targetLevel: 90 }
]

// è³‡æ–™è¼‰å…¥ç‹€æ…‹
const playerBuildData = ref(null)
const targetBuildData = ref(null)
const comparisonResult = ref(null)

// æ¸¬è©¦ API é€£ç·š
const testApi = async () => {
    try {
        currentStep.value = 'test'
        loading.value = true

        console.log('ğŸ” æ¸¬è©¦ API é€£ç·š:', `${API_BASE_URL}/test`)

        const response = await fetch(`${API_BASE_URL}/test`)

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }

        const data = await response.json()

        if (data.success) {
            alert(`âœ… API é€£ç·šæˆåŠŸï¼\n${data.message}\nLaravel ç‰ˆæœ¬: ${data.version}`)
        } else {
            alert('âŒ API é€£ç·šå¤±æ•—ï¼šå›æ‡‰æ ¼å¼éŒ¯èª¤')
        }
    } catch (error) {
        console.error('API é€£ç·šéŒ¯èª¤:', error)
        alert(`âŒ API é€£ç·šå¤±æ•—ï¼š${error.message}\n\nè«‹ç¢ºèªï¼š\n1. Laravel æœå‹™å™¨æ­£åœ¨é‹è¡Œ (php artisan serve)\n2. ç«¯å£ 8000 å¯ä»¥è¨ªå•\n3. CORS è¨­å®šæ­£ç¢º`)
    } finally {
        loading.value = false
        currentStep.value = ''
    }
}

// è¼‰å…¥ç©å®¶ PoB
const loadPlayerBuild = async () => {
    if (!playerPobCode.value.trim()) {
        alert('è«‹å…ˆè²¼ä¸Šä½ çš„ PoB ä»£ç¢¼')
        return
    }

    try {
        currentStep.value = 'player'
        loading.value = true

        console.log('ğŸ” è§£æç©å®¶ PoB')

        const response = await fetch(`${API_BASE_URL}/build/parse-pob`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ pob_code: playerPobCode.value })
        })

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`)
        }

        const result = await response.json()
        console.log('ğŸ“¦ å¾Œç«¯è¿”å›:', result)

        if (result.success && result.data?.status === 'success') {
            const rawData = result.data.data

            // â­ åˆ†åˆ¥è™•ç†ï¼šé¡¯ç¤ºç”¨ + å¾Œç«¯ç”¨
            playerBuildData.value = {
                // çµ¦å¾Œç«¯æ¯”å°ç”¨çš„å®Œæ•´è³‡æ–™
                ...transformPobDataForBackend(rawData),
                // çµ¦å‰ç«¯é¡¯ç¤ºç”¨çš„ç°¡åŒ–è³‡æ–™
                ...extractDisplayInfo(rawData)
            }

            console.log('âœ… ç©å®¶è³‡æ–™å·²è™•ç†:', playerBuildData.value)
            alert('âœ… ä½ çš„è§’è‰²è¼‰å…¥æˆåŠŸï¼')
        } else {
            throw new Error(result.message || 'PoB è§£æå¤±æ•—')
        }
    } catch (error) {
        console.error('âŒ è¼‰å…¥å¤±æ•—:', error)
        alert(`âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}`)
    } finally {
        loading.value = false
        currentStep.value = ''
    }
}

// è¼‰å…¥ç›®æ¨™æµæ´¾ PoB  
const loadTargetBuild = async () => {
    if (!targetPobCode.value.trim()) {
        alert('è«‹å…ˆè²¼ä¸Šç›®æ¨™æµæ´¾çš„ PoB ä»£ç¢¼')
        return
    }

    try {
        currentStep.value = 'target'
        loading.value = true

        console.log('ğŸ” è§£æç›®æ¨™ PoB')

        const response = await fetch(`${API_BASE_URL}/build/parse-pob`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ pob_code: targetPobCode.value })
        })

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`)
        }

        const result = await response.json()
        console.log('ğŸ“¦ å¾Œç«¯è¿”å›:', result)

        if (result.success && result.data?.status === 'success') {
            const rawData = result.data.data

            // â­ åˆ†åˆ¥è™•ç†ï¼šé¡¯ç¤ºç”¨ + å¾Œç«¯ç”¨
            targetBuildData.value = {
                // çµ¦å¾Œç«¯æ¯”å°ç”¨çš„å®Œæ•´è³‡æ–™
                ...transformPobDataForBackend(rawData),
                // çµ¦å‰ç«¯é¡¯ç¤ºç”¨çš„ç°¡åŒ–è³‡æ–™
                ...extractDisplayInfo(rawData)
            }

            console.log('âœ… ç›®æ¨™è³‡æ–™å·²è™•ç†:', targetBuildData.value)
            alert('âœ… ç›®æ¨™æµæ´¾è¼‰å…¥æˆåŠŸï¼')
        } else {
            throw new Error(result.message || 'PoB è§£æå¤±æ•—')
        }
    } catch (error) {
        console.error('âŒ è¼‰å…¥å¤±æ•—:', error)
        alert(`âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}`)
    } finally {
        loading.value = false
        currentStep.value = ''
    }
}

// é–‹å§‹æ¯”å°åˆ†æ
const startComparison = async () => {
    if (!playerBuildData.value || !targetBuildData.value) {
        alert('è«‹å…ˆè¼‰å…¥å…©å€‹æµæ´¾')
        return
    }

    try {
        currentStep.value = 'compare'
        loading.value = true

        const stage = stages.find(s => s.id === selectedStage.value)

        console.log('ğŸ” é–‹å§‹é…ç½®æ¯”å°:', {
            stage: selectedStage.value,
            targetLevel: stage.targetLevel
        })

        const response = await fetch(`${API_BASE_URL}/build/compare-builds`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                player_build: playerBuildData.value,
                target_build: targetBuildData.value,
                target_level: stage.targetLevel,
                stage: selectedStage.value
            })
        })

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }

        const result = await response.json()
        console.log('ğŸ” æ¯”å°çµæœ:', result)

        if (result.success) {
            comparisonResult.value = result
            alert('âœ… é…ç½®åˆ†æå®Œæˆï¼è«‹æŸ¥çœ‹ä¸‹æ–¹çµæœ')

            // æ»¾å‹•åˆ°çµæœå€åŸŸ
            setTimeout(() => {
                document.querySelector('section:last-child')?.scrollIntoView({ behavior: 'smooth' })
            }, 100)
        } else {
            throw new Error(result.message || 'é…ç½®åˆ†æå¤±æ•—')
        }
    } catch (error) {
        console.error('é…ç½®åˆ†æå¤±æ•—:', error)
        alert(`âŒ æ¯”å°å¤±æ•—ï¼š${error.message}`)
    } finally {
        loading.value = false
        currentStep.value = ''
    }
}

// é¸æ“‡éšæ®µ
const selectStage = (stageId) => {
    selectedStage.value = stageId
    console.log('âœ… é¸æ“‡éšæ®µ:', stageId)
}

const transformPobDataForBackend = (pobData) => {
    return {
        character_info: pobData.character_info || {},
        skill_configuration: pobData.skill_configuration || [],
        passive_tree: pobData.passive_tree || {},
        equipment_configuration: pobData.equipment_configuration || {}
    }
}

const extractDisplayInfo = (pobData) => {
    const characterInfo = pobData.character_info || {}
    const skillConfig = pobData.skill_configuration || []
    const tree = pobData.passive_tree || {}

    console.log('ğŸ” æå–é¡¯ç¤ºè³‡è¨Š:', {
        æŠ€èƒ½é…ç½®æ•¸: skillConfig.length,
        å¤©è³¦æ¨¹: tree
    })

    // ğŸ”§ è­˜åˆ¥ä¸»æŠ€èƒ½ï¼šæ‰¾ç¬¬ä¸€å€‹æœ‰ä¸»å‹•å¯¶çŸ³çš„æŠ€èƒ½çµ„
    let mainSkillInfo = null

    for (const skillSet of skillConfig) {
        if (!skillSet.enabled || !skillSet.gems || skillSet.gems.length === 0) {
            continue
        }

        // æ‰¾åˆ°ä¸»å‹•æŠ€èƒ½å¯¶çŸ³ï¼ˆis_support ç‚º false æˆ–ä¸å­˜åœ¨ï¼‰
        const activeGem = skillSet.gems.find(g => g.is_support === false)

        if (activeGem) {
            mainSkillInfo = {
                name: activeGem.name || 'Unknown',
                level: activeGem.level || 1,
                quality: activeGem.quality || 0,
                linkCount: skillSet.gems.length
            }

            console.log('âœ… æ‰¾åˆ°ä¸»æŠ€èƒ½:', mainSkillInfo)
            break
        }
    }

    // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œå–ç¬¬ä¸€å€‹æŠ€èƒ½çµ„çš„ç¬¬ä¸€å€‹å¯¶çŸ³
    if (!mainSkillInfo && skillConfig.length > 0) {
        const firstSkill = skillConfig[0]
        if (firstSkill.gems && firstSkill.gems.length > 0) {
            // å¾å¯¶çŸ³åˆ—è¡¨ä¸­æ‰¾ç¬¬ä¸€å€‹éè¼”åŠ©å¯¶çŸ³
            const firstActiveGem = firstSkill.gems.find(g => g.is_support === false)
            const gemToUse = firstActiveGem || firstSkill.gems[0]

            mainSkillInfo = {
                name: gemToUse.name || 'Unknown',
                level: gemToUse.level || 1,
                quality: gemToUse.quality || 0,
                linkCount: firstSkill.gems.length
            }
            console.log('âš ï¸ ä½¿ç”¨å‚™ç”¨æ–¹å¼è­˜åˆ¥ä¸»æŠ€èƒ½:', mainSkillInfo)
        }
    }

    // ğŸ”§ è™•ç†å¤©è³¦æ¨¹è³‡è¨Š
    let passiveTreeInfo = {
        nodes: tree.nodes || [],
        total: tree.total || 0,
        url: tree.url || '',
        note: tree.note || null
    }

    // å¦‚æœæœ‰ URL ä½†æ²’æœ‰ç¯€é»ï¼Œèªªæ˜å¤©è³¦æ¨¹è³‡æ–™åœ¨ URL ä¸­
    if (passiveTreeInfo.url && passiveTreeInfo.total === 0) {
        console.log('âš ï¸ å¤©è³¦æ¨¹è³‡æ–™å­˜åœ¨æ–¼ URL ä¸­ï¼Œç„¡æ³•ç›´æ¥æå–ç¯€é»')
    }

    console.log('âœ… å¤©è³¦æ¨¹è³‡è¨Š:', passiveTreeInfo)

    return {
        character_info: characterInfo,
        main_skill_info: mainSkillInfo,
        passive_tree: passiveTreeInfo
    }
}
</script>

<style scoped>
/* è‡ªå®šç¾©æ¨£å¼ */
.container {
    max-width: 1200px;
}
</style>